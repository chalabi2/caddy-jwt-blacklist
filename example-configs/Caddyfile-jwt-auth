# JWT Authentication + Blacklist Integration
# Shows how to use JWT blacklist with JWT authentication module

{
	admin localhost:2019
	
	log {
		output stdout
		format json
		level INFO
	}
}

# Protected API with JWT auth + blacklist
api.example.com {
	route {
		# Handle CORS preflight requests FIRST
		@options method OPTIONS
		handle @options {
			header {
				Access-Control-Allow-Origin *
				Access-Control-Allow-Methods "GET, POST, OPTIONS"
				Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-API-Key"
				Access-Control-Max-Age 86400
			}
			respond "" 204
		}

		# Step 1: JWT Blacklist Check (before authentication)
		jwt_blacklist {
			redis_addr {env.REDIS_URL}
			redis_password {env.REDIS_PASSWORD}
			redis_db 0
			jwt_secret {env.JWT_SECRET}
			blacklist_prefix "BLACKLIST:key:"
			fail_open true
			timeout 50ms
			log_blocked true
			
			# Optional TLS for production Redis
			# tls {
			#     enabled true
			#     min_version "1.2"
			#     server_name {env.REDIS_HOST}
			# }
		}

		# Step 2: JWT Authentication
		jwtauth {
			sign_key {env.JWT_SECRET}
			sign_alg HS256
			from_query api_key access_token token
			from_header Authorization X-Api-Token X-API-Key
			from_cookies session_token
			user_claims sub jti uid user_id
			meta_claims "tier" "scope"
		}

		# Add authenticated user info to response headers
		header {
			X-User-ID {http.auth.user.id}
			X-User-Tier {http.auth.user.tier}
			X-User-Scope {http.auth.user.scope}
		}

		# Protected endpoints
		handle /api/profile {
			respond `{"user_id":"{http.auth.user.id}","tier":"{http.auth.user.tier}","scope":"{http.auth.user.scope}"}`
		}
		
		handle /api/data {
			respond `{"message":"Protected data access","user":"{http.auth.user.id}","timestamp":"{time.now.unix}"}`
		}

		handle /status {
			respond `{"status":"ok","authenticated":true,"user_id":"{http.auth.user.id}"}`
		}

		handle {
			respond `{"error":"not_found","message":"Endpoint not found"}` 404
		}
	}

	# Enhanced error handling for blacklist + auth
	handle_errors {
		@blacklist_error expression `{http.error.status_code} == 401 && {http.error.message} contains "blacklisted"`
		header @blacklist_error {
			X-Error-Type "api_key_blacklisted"
			WWW-Authenticate "Bearer"
		}
		respond @blacklist_error `{"error":"api_key_blacklisted","message":"API key has been disabled","code":401,"details":"Please generate a new API key"}` 401

		@auth_error expression `{http.error.status_code} == 401`
		header @auth_error {
			X-Error-Type "authentication_failed"
			WWW-Authenticate "Bearer"
		}
		respond @auth_error `{"error":"unauthorized","message":"Invalid or missing API key","code":401}` 401

		respond `{"error":"{http.error.status_code}","message":"{http.error.status_text}"}` {http.error.status_code}
	}

	# CORS headers for all responses
	header {
		Access-Control-Allow-Origin *
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-API-Key"
		Access-Control-Expose-Headers "X-User-ID, X-User-Tier"
	}
}