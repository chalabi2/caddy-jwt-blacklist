{
  "admin": {
    "listen": "localhost:2019"
  },
  "logging": {
    "logs": {
      "default": {
        "writer": {
          "output": "stdout"
        },
        "encoder": {
          "format": "json"
        },
        "level": "INFO"
      }
    }
  },
  "apps": {
    "http": {
      "servers": {
        "basic_stateful_jwt": {
          "listen": [":8080"],
          "routes": [
            {
              "match": [
                {
                  "host": ["localhost"]
                }
              ],
              "handle": [
                {
                  "handler": "stateful_jwt",
                  "config": {
                    "redis_addr": "localhost:6379",
                    "redis_password": "",
                    "redis_db": 0,
                    "blacklist_prefix": "BLACKLIST:key:",
                    "timeout": "50ms",
                    "fail_open": true,
                    "log_blocked": true,
                    "jwt": {
                      "sign_key": "{env.JWT_SECRET}",
                      "sign_alg": "HS256",
                      "from_query": ["api_key", "access_token", "token"],
                      "from_header": ["Authorization", "X-API-Key"],
                      "from_cookies": ["session_token"],
                      "user_claims": ["sub", "jti"],
                      "meta_claims": {
                        "tier": "tier",
                        "scope": "scope"
                      }
                    }
                  }
                },
                {
                  "handler": "static_response",
                  "body": "{\"message\":\"Hello {http.auth.user.id}!\",\"tier\":\"{http.auth.user.tier}\",\"api_key_id\":\"{http.auth.user.jti}\",\"timestamp\":\"{time.now.unix}\"}"
                }
              ]
            }
          ]
        },
        "stateful_jwt_tls": {
          "listen": [":443"],
          "routes": [
            {
              "match": [
                {
                  "host": ["api.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "handle": [
                        {
                          "handler": "stateful_jwt",
                          "config": {
                            "redis_addr": "your-redis-host.com:6379",
                            "redis_password": "{env.REDIS_PASSWORD}",
                            "redis_db": 0,
                            "blacklist_prefix": "BLACKLIST:key:",
                            "timeout": "100ms",
                            "fail_open": true,
                            "log_blocked": true,
                            "redis_tls": {
                              "enabled": true,
                              "server_name": "your-redis-host.com",
                              "min_version": "1.2"
                            },
                            "jwt": {
                              "sign_key": "{env.JWT_SECRET}",
                              "sign_alg": "HS256",
                              "from_query": [
                                "api_key",
                                "access_token",
                                "token"
                              ],
                              "from_header": [
                                "Authorization",
                                "X-Api-Token",
                                "X-API-Key"
                              ],
                              "from_cookies": ["session_token"],
                              "user_claims": ["sub", "jti", "uid", "user_id"],
                              "meta_claims": {
                                "tier": "tier",
                                "scope": "scope",
                                "org_id": "org_id"
                              }
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "method": ["OPTIONS"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "headers",
                          "response": {
                            "set": {
                              "Access-Control-Allow-Origin": ["*"],
                              "Access-Control-Allow-Methods": [
                                "GET, POST, OPTIONS"
                              ],
                              "Access-Control-Allow-Headers": [
                                "Origin, Content-Type, Accept, Authorization, X-API-Key"
                              ],
                              "Access-Control-Max-Age": ["86400"]
                            }
                          }
                        },
                        {
                          "handler": "static_response",
                          "status_code": 204
                        }
                      ]
                    },
                    {
                      "handle": [
                        {
                          "handler": "headers",
                          "response": {
                            "set": {
                              "X-User-ID": ["{http.auth.user.id}"],
                              "X-User-Tier": ["{http.auth.user.tier}"],
                              "X-API-Key-ID": ["{http.auth.user.jti}"]
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/status"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "static_response",
                          "body": "{\"status\":\"ok\",\"user_id\":\"{http.auth.user.id}\",\"tier\":\"{http.auth.user.tier}\",\"org_id\":\"{http.auth.user.org_id}\"}",
                          "status_code": 200
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/api/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "upstreams": [
                            {
                              "dial": "localhost:8081"
                            }
                          ],
                          "headers": {
                            "request": {
                              "set": {
                                "X-User-ID": ["{http.auth.user.id}"],
                                "X-User-Tier": ["{http.auth.user.tier}"],
                                "X-Forwarded-For": ["{remote_ip}"]
                              }
                            }
                          }
                        }
                      ]
                    },
                    {
                      "handle": [
                        {
                          "handler": "static_response",
                          "body": "{\"error\":\"not_found\",\"message\":\"Endpoint not found\"}",
                          "status_code": 404
                        }
                      ]
                    }
                  ]
                }
              ],
              "handle_errors": [
                {
                  "match": {
                    "expression": "{http.error.status_code} == 401 && \"blacklisted\" in {http.error.message}"
                  },
                  "handle": [
                    {
                      "handler": "headers",
                      "response": {
                        "set": {
                          "X-Error-Type": ["api_key_blacklisted"],
                          "WWW-Authenticate": ["Bearer"]
                        }
                      }
                    },
                    {
                      "handler": "static_response",
                      "body": "{\"error\":\"api_key_blacklisted\",\"message\":\"API key has been disabled\",\"code\":401}",
                      "status_code": 401
                    }
                  ]
                },
                {
                  "match": {
                    "expression": "{http.error.status_code} == 401"
                  },
                  "handle": [
                    {
                      "handler": "headers",
                      "response": {
                        "set": {
                          "X-Error-Type": ["authentication_failed"],
                          "WWW-Authenticate": ["Bearer"]
                        }
                      }
                    },
                    {
                      "handler": "static_response",
                      "body": "{\"error\":\"unauthorized\",\"message\":\"Invalid or missing API key\",\"code\":401}",
                      "status_code": 401
                    }
                  ]
                },
                {
                  "handle": [
                    {
                      "handler": "static_response",
                      "body": "{\"error\":\"{http.error.status_code}\",\"message\":\"{http.error.status_text}\"}",
                      "status_code": "{http.error.status_code}"
                    }
                  ]
                }
              ]
            }
          ]
        },
        "jwt_only": {
          "listen": [":443"],
          "routes": [
            {
              "match": [
                {
                  "host": ["jwt-only.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "handle": [
                        {
                          "handler": "stateful_jwt",
                          "config": {
                            "redis_addr": "disabled",
                            "fail_open": true,
                            "timeout": "100ms",
                            "jwt": {
                              "sign_key": "{env.JWT_SECRET}",
                              "sign_alg": "HS256",
                              "from_query": [
                                "api_key",
                                "access_token",
                                "token"
                              ],
                              "from_header": [
                                "Authorization",
                                "X-Api-Token",
                                "X-API-Key"
                              ],
                              "from_cookies": ["session_token"],
                              "user_claims": ["sub", "jti", "uid", "user_id"],
                              "meta_claims": {
                                "tier": "tier",
                                "scope": "scope"
                              }
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "method": ["OPTIONS"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "headers",
                          "response": {
                            "set": {
                              "Access-Control-Allow-Origin": ["*"],
                              "Access-Control-Allow-Methods": [
                                "GET, POST, OPTIONS"
                              ],
                              "Access-Control-Allow-Headers": [
                                "Origin, Content-Type, Accept, Authorization, X-API-Key"
                              ]
                            }
                          }
                        },
                        {
                          "handler": "static_response",
                          "status_code": 204
                        }
                      ]
                    },
                    {
                      "handle": [
                        {
                          "handler": "headers",
                          "response": {
                            "set": {
                              "X-User-ID": ["{http.auth.user.id}"],
                              "X-User-Tier": ["{http.auth.user.tier}"]
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/status"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "static_response",
                          "body": "{\"status\":\"ok\",\"auth_mode\":\"jwt_only\",\"user_id\":\"{http.auth.user.id}\",\"tier\":\"{http.auth.user.tier}\"}",
                          "status_code": 200
                        }
                      ]
                    },
                    {
                      "handle": [
                        {
                          "handler": "static_response",
                          "body": "{\"error\":\"not_found\",\"message\":\"Endpoint not found\"}",
                          "status_code": 404
                        }
                      ]
                    }
                  ]
                }
              ],
              "handle_errors": [
                {
                  "match": {
                    "expression": "{http.error.status_code} == 401"
                  },
                  "handle": [
                    {
                      "handler": "static_response",
                      "body": "{\"error\":\"unauthorized\",\"message\":\"Invalid JWT token\",\"code\":401}",
                      "status_code": 401
                    }
                  ]
                },
                {
                  "handle": [
                    {
                      "handler": "static_response",
                      "body": "{\"error\":\"{http.error.status_code}\",\"message\":\"{http.error.status_text}\"}",
                      "status_code": "{http.error.status_code}"
                    }
                  ]
                }
              ]
            }
          ]
        }
      }
    }
  }
}
